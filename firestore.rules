rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Public read access for items. Write access only for the seller.
    match /items/{itemId} {
      allow read: if true;
      allow write: if request.auth.uid == resource.data.sellerId;

      // Allow authenticated users to log views on items.
      match /views/{viewId} {
        allow create: if request.auth != null;
      }
    }
    
    // Users can only read/write their own user document.
    match /users/{userId} {
        allow read, write: if request.auth.uid == userId;
    }
    
    // Users can manage their own favorites.
    match /userFavorites/{favoriteId} {
        // A user can get their own favorite doc.
        allow get: if request.auth.uid == resource.data.userId;
        // A user can list favorites, but the query MUST be constrained to their UID on the client.
        allow list: if request.auth != null;
        // A user can only create a favorite for themselves.
        allow create: if request.auth.uid == request.resource.data.userId;
        // A user can only delete their own favorite.
        allow delete: if request.auth.uid == resource.data.userId;
    }

    // Rules for message threads.
    match /messageThreads/{threadId} {
        // Users can only read/write threads they are a part of.
        allow read, write: if request.auth.uid in resource.data.participantIds;
        
        // Rules for messages within a thread.
        match /messages/{messageId} {
            // Users can only read/write messages in threads they are a part of.
            allow read, write: if request.auth.uid in get(/databases/$(database)/documents/messageThreads/$(threadId)).data.participantIds;
        }
    }

    // Rules for product reports.
    match /productReports/{itemId}/reports/{userId} {
        allow read, create: if request.auth.uid == userId;
    }

    // Rules for reviews.
    match /reviews/{reviewId} {
        allow read: if true;
        allow create: if request.auth.uid == request.resource.data.reviewerId;
    }
  }
}
