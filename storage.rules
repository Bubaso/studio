
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Avatars: Users can read anyone's avatar, but only write/delete their own.
    match /avatars/{userId}/{allPaths=**} {
      allow read: if true;
      allow write, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Item Images: Users can read anyone's item images.
    // Sellers can create, update, or delete images under their own user ID folder.
    match /items/{userId}/{allPaths=**} {
      allow read: if true;
      allow write, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Chat attachments: Only participants of a thread can read/write attachments.
    // This rule is more complex as it needs to check the messageThreads collection.
    // For simplicity, we'll allow any authenticated user to write to their own user-id-scoped folder.
    // Reading would ideally be restricted based on thread participation.
    match /chatAttachments/{threadId}/{userId}/{allPaths=**} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}
